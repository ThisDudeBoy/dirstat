name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dirstat-windows
          path: build/Release/dirstat.exe
          if-no-files-found: warn

      - name: Upload artifact (MinGW path)
        uses: actions/upload-artifact@v4
        with:
          name: dirstat-windows-mingw
          path: build/dirstat.exe
          if-no-files-found: warn

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          pattern: dirstat-windows*
          merge-multiple: true

      - name: List files
        run: ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dirstat.exe
          body: |
            ## âš¡ dirstat ${{ github.ref_name }}
            
            Lightning-fast directory analyzer for Windows.
            
            ### Installation
            1. Download `dirstat.exe`
            2. Put it somewhere in your PATH (or run directly)
            3. Done!
            
            ### Usage
            ```
            dirstat              # Scan current directory
            dirstat large        # Find largest files
            dirstat tree         # Show directory tree
            dirstat types        # File type breakdown
            dirstat help         # Show help
            ```
          draft: false
          prerelease: false
